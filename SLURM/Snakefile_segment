# Snakefile for segmentation workflow
# Process individual timepoint files in parallel from input directory

import os
from pathlib import Path
import glob

# Configuration
INPUT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/lymphnode_analysis/data2track/b2-2a_2c_pos6-01_deskew_cgt/crop3/restored"
OUTPUT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/lymphnode_analysis/data2track/b2-2a_2c_pos6-01_deskew_cgt/crop3/segmentation"
MODEL_PATH = "/users/kir-fritzsche/aif490/devel/tissue_analysis/segmentation_scripts/SLURM/models/cp3_addnoise_model"
SCRIPT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/segmentation_scripts"

# Segmentation parameters
GAMMA = 1.0
TILE_SIZE = [256, 288, 288]  # Z, Y, X
OVERLAP = 32

# Get list of input files and determine number of timepoints
input_files = sorted(glob.glob(os.path.join(INPUT_DIR, "restored_timepoint_*.tif")))
N_TIMEPOINTS = len(input_files)

# Extract timepoint numbers from filenames
timepoints = []
for f in input_files:
    basename = os.path.basename(f)
    # Extract number from "restored_timepoint_X.tif"
    tp = basename.replace("restored_timepoint_", "").replace(".tif", "")
    timepoints.append(int(tp))

# Rule to define the final outputs
rule all:
    input:
        expand(os.path.join(OUTPUT_DIR, "restored_timepoint_{timepoint:04d}_segmented.tif"),
               timepoint=timepoints)

# Rule to segment individual timepoint files
rule segment_timepoint:
    input:
        os.path.join(INPUT_DIR , "restored_timepoint_{timepoint,\d{4}}.tif")
    output:
        os.path.join(OUTPUT_DIR, "restored_timepoint_{timepoint,\d{4}}_segmented.tif")
    params:
        file_index = lambda wildcards: timepoints.index(int(wildcards.timepoint))
    resources:
        mem_mb = 132000,
        runtime = 90,
        cpus = 1,
        slurm_partition = "gpu_short",
        slurm_extra = "--gres=gpu:1 --exclude=compg009,compg010,compg011,compg013"
    log:
        "slogs/segment_timepoint_{timepoint}.log"
    shell:
        """
        module purge
        source /well/kir/config/modules.sh
        module load Python/3.10.8-GCCcore-12.2.0
        module load CUDA/12.0
        source ~/devel/venv/Python-3.10.8-GCCcore-12.2.0/cellpose3_env/bin/activate
        
        python3 -u {SCRIPT_DIR}/tiled_segmentation_3views.py \
            --input_dir {INPUT_DIR} \
            --output_dir {OUTPUT_DIR} \
            --model {MODEL_PATH} \
            --gamma {GAMMA} \
            --tile_size {TILE_SIZE[0]} {TILE_SIZE[1]} {TILE_SIZE[2]} \
            --overlap {OVERLAP} \
            --file_index {params.file_index} \
            --verbose &> {log}
        """

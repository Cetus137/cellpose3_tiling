# Snakefile for segmentation workflow
# Process individual timepoint files in parallel from input directory

import os
from pathlib import Path
import glob
import re

# Configuration
INPUT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/lymphnode_analysis/data2track/b2-2a_2c_pos6-01_deskew_cgt/crop3/restored"
OUTPUT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/lymphnode_analysis/data2track/b2-2a_2c_pos6-01_deskew_cgt/crop3/segmentation/cellpose/tiles"
OUTPUT_DIR_RECONSTRUCTED = "/users/kir-fritzsche/aif490/devel/tissue_analysis/lymphnode_analysis/data2track/b2-2a_2c_pos6-01_deskew_cgt/crop3/segmentation/cellpose/reconstructed"
MODEL_PATH = "/users/kir-fritzsche/aif490/devel/tissue_analysis/segmentation_scripts/SLURM/models/cp3_addnoise_model"
SCRIPT_DIR = "/users/kir-fritzsche/aif490/devel/tissue_analysis/segmentation_scripts"

# Segmentation parameters
GAMMA = 1.0
TILE_SIZE = [256, 288, 288]  # Z, Y, X
OVERLAP = 32
CELLPROB_THRESHOLD = 2.0

cellpose_config_dict = {
    'model_path': MODEL_PATH,
    'gamma': GAMMA,
    'cellprob_threshold': CELLPROB_THRESHOLD,
    'do_3D': True
}

# Count all segmentation files in directory and subdirectories using os.walk
files_to_seg = []
for root, dirs, files in os.walk(INPUT_DIR):
    for file in files:
        if (file.endswith('.tif') or file.endswith('.tiff')) and 'tile' in file:
            files_to_seg.append(os.path.join(root, file))

N_FILES = len(files_to_seg)

# Create mapping of basenames to full paths for easy lookup
file_basenames = [os.path.splitext(os.path.basename(f))[0] for f in files_to_seg]
file_path_map = {os.path.splitext(os.path.basename(f))[0]: f for f in files_to_seg}

print(f"Found {N_FILES} tile files to process")

# Extract unique timepoints from filenames (format: *_timepoint_0001_*.tif)


# helper: extract 4-digit timepoint from a basename like "restored_timepoint_0001_tile_..."
def basename_timepoint(basename):
    m = re.search(r'(\d{4})', basename)
    return int(m.group(1)) if m else None

# list of timepoints present in your tile basenames
timepoints = sorted({basename_timepoint(b) for b in file_basenames if basename_timepoint(b) is not None})
print("Found timepoints:", timepoints)


N_TIMEPOINTS = len(timepoints)


# Rule to define the final outputs
rule all:
    input:
        expand(os.path.join(OUTPUT_DIR_RECONSTRUCTED, "restored_timepoint_{timepoint:04d}_segmented.tif"),
               timepoint=timepoints )  # Adjust range as needed
# Rule to segment individual tile files
rule segment_tiles:
    input:
        lambda wildcards: file_path_map[wildcards.basename]
    output:
        os.path.join(OUTPUT_DIR, "{basename}_dP_blur.tif"),
        os.path.join(OUTPUT_DIR, "{basename}_cellprob_blur.tif")
    params:
        file_index = lambda wildcards: file_basenames.index(wildcards.basename)
    resources:
        mem_mb = 132000,
        runtime = 90,
        cpus = 1,
        slurm_partition = "short",
        slurm_extra = "--exclude=compg009,compg010,compg011,compg013"
    log:
        "slogs/segment_{basename}.log"
    shell:
        """
        export TMPDIR=/well/kir-fritzsche/users/aif490/tmp
        mkdir -p $TMPDIR
        
        module purge
        source /well/kir/config/modules.sh
        module load Python/3.10.8-GCCcore-12.2.0
        module load CUDA/12.0
        source ~/devel/venv/Python-3.10.8-GCCcore-12.2.0/cellpose3_env/bin/activate

        python3 -u {SCRIPT_DIR}/batch_tile_segmentation_3views.py \
            --input_dir {INPUT_DIR} \
            --output_dir {OUTPUT_DIR} \
            --model {MODEL_PATH} \
            --file_index {params.file_index} \
            --cellprob_threshold {CELLPROB_THRESHOLD} \
            --verbose &> {log}
        """


#Rule to reconstruct from tiles
rule reconstruct_from_tiles:
    input:
        dP = lambda wildcards: [
            os.path.join(OUTPUT_DIR, f"{b}_dP_blur.tif")
            for b in file_basenames
            if basename_timepoint(b) == int(wildcards.timepoint)
        ],
        cellprob = lambda wildcards: [
            os.path.join(OUTPUT_DIR, f"{b}_cellprob_blur.tif")
            for b in file_basenames
            if basename_timepoint(b) == int(wildcards.timepoint)
        ]

    output:
        os.path.join(OUTPUT_DIR_RECONSTRUCTED, "restored_timepoint_{timepoint,\d{4}}_segmented.tif")
    params:
        timepoint = lambda wildcards: int(wildcards.timepoint)
    resources:
        mem_mb = 132000,
        runtime = 90,
        cpus = 1,
        slurm_partition = "short",
        slurm_extra = "--exclude=compg009,compg010,compg011,compg013"
    log:
        "slogs/reconstruct_masks_timepoint_{timepoint}.log"
    shell:
        """
        export TMPDIR=/well/kir-fritzsche/users/aif490/tmp
        mkdir -p $TMPDIR

        module purge
        source /well/kir/config/modules.sh
        module load Python/3.10.8-GCCcore-12.2.0
        module load CUDA/12.0
        source ~/devel/venv/Python-3.10.8-GCCcore-12.2.0/cellpose3_env/bin/activate

        python3 -u {SCRIPT_DIR}/batch_tile_reconstruction_3views.py \
            --tile_dir {OUTPUT_DIR} \
            --output_dir {OUTPUT_DIR_RECONSTRUCTED} \
            --timepoint {params.timepoint} \
            --cellpose_config_dict {cellpose_config_dict} \
            --verbose &> {log}
        """